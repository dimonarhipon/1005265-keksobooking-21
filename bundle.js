(()=>{"use strict";!function(){const e=document.querySelector("#success").content.querySelector(".success"),t=document.querySelector("#error").content.querySelector(".error"),n=t.querySelector(".error__button");window.util={getRandomNumber:(e,t=0)=>Math.floor(Math.random()*(e-t)+t),errorHandler:e=>{const t=document.createElement("div");t.style="z-index: 5; margin: 0 auto; text-align: center; background-color: tomato;",t.style.position="absolute",t.style.width="400px",t.style.height="80px",t.style.color="#ffffff",t.style.left=0,t.style.right=0,t.style.fontSize="28px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},openSuccessPopup:()=>{const t=e.cloneNode(!0);document.body.insertAdjacentElement("afterbegin",t),document.addEventListener("click",(()=>{t.style.display="none"})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(e.preventDefault(),t.style.display="none")}))},openErrorPopup:()=>{const e=t.cloneNode(!0);document.body.insertAdjacentElement("afterbegin",e),document.addEventListener("click",(()=>{e.style.display="none"})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&(t.preventDefault(),e.style.display="none")})),n.addEventListener("click",(()=>{e.style.display="none"}))},debounce:e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}}}}(),function(){window.backend={load:(t,n)=>{const o=e(t,n);o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},post:(t,n,o)=>{const r=e(n,o);r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(t)}};const e=(e,t)=>{const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",(function(){400===n.status?t(`Неверный запрос: ${n.status} ${n.statusText}`):404===n.status?t(`Не найдено: ${n.status} ${n.statusText}`):500===n.status?t(`Ошибка сервера: ${n.status} ${n.statusText}`):200!==n.status?t(`Статус ответа: ${n.status} ${n.statusText}`):e(n.response)})),n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.addEventListener("timeout",(function(){t(`Запрос не успел выполниться за ${n.timeout} мс`)})),n.timeout=7e3,n}}(),function(){const e=document.querySelector("#pin").content.querySelector(".map__pin");window.advert={render:t=>{const n=e.cloneNode(!0),o=n.querySelector("img");return n.style=`left: ${t.location.x}px; top: ${t.location.y}px`,o.src=t.author.avatar,o.alt=t.offer.title,n.classList.add("hidden"),n}}}(),function(){const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t=document.querySelector("#card").content.querySelector(".map__card");window.card={render:n=>{const o=t.cloneNode(!0),r=o.querySelector(".popup__title"),i=o.querySelector(".popup__text--address"),a=o.querySelector(".popup__text--price"),s=o.querySelector(".popup__type"),d=o.querySelector(".popup__text--capacity"),l=o.querySelector(".popup__text--time "),c=o.querySelector(".popup__features"),u=o.querySelector(".popup__description"),p=o.querySelector(".popup__photos"),m=o.querySelector(".popup__avatar");return m.src=n.author.avatar,m.alt=n.offer.title,r.textContent=n.offer.title,i.textContent=n.offer.address,a.textContent=n.offer.price+" ₽/ночь.",s.textContent=e[n.offer.type],d.textContent=`${n.offer.rooms} комнаты для ${n.offer.guests} гостей`,l.textContent=`Заезд после ${n.offer.checkin}, выезд до ${n.offer.checkout}`,(e=>{c.innerHTML="";const t=document.createDocumentFragment();for(let n=0;n<e.offer.features.length;n++){const o=document.createElement("li");o.className="popup__feature popup__feature--"+e.offer.features[n],t.appendChild(o)}c.appendChild(t)})(n),u.textContent=n.offer.description,(e=>{p.innerHTML="";const t=document.createDocumentFragment();for(let n=0;n<e.offer.photos.length;n++){const o=document.createElement("img");o.src=e.offer.photos[n],o.width=40,o.height=40,t.appendChild(o)}p.appendChild(t)})(n),o.classList.add("hidden"),o}}}(),function(){const e=document.querySelector(".map");window.map={workSpace:e,disablePage:(t=!0,n=!1)=>{e.classList.add("map--faded"),window.form.container.classList.add("ad-form--disabled"),window.form.fieldsets.map((e=>e.disabled=t)),window.mapFilter.fieldsets.map((e=>e.disabled=t)),window.mapFilter.selects.map((e=>e.disabled=t)),(e=>{e&&window.backend.load(window.pin.successHandler,window.util.errorHandler)})(n),t||(e.classList.remove("map--faded"),window.form.container.classList.remove("ad-form--disabled"))}}}(),function(){const e={ANY:{min:0,max:1/0},LOW:{min:0,max:1e4},MIDDLE:{min:1e4,max:5e4},HIGH:{min:5e4,max:1/0}},t=window.map.workSpace.querySelector(".map__filters"),n=t.querySelector("#housing-type"),o=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),i=t.querySelector("#housing-guests"),a=t.querySelector("#housing-features"),s=(e,t,n)=>"any"===e.value||e.value===t[n].toString(),d=e=>s(n,e.offer,"type"),l=t=>{const n=e[o.value.toUpperCase()];return!n||t.offer.price>=n.min&&t.offer.price<=n.max},c=e=>s(r,e.offer,"rooms"),u=e=>s(i,e.offer,"guests"),p=e=>Array.from(a.querySelectorAll("input:checked")).every((t=>e.offer.features.includes(t.value))),m=window.util.debounce((e=>{const t=e;window.pin.removeElements();const n=t.filter(d).filter(l).filter(c).filter(u).filter(p);window.pin.renderElements(n),window.pin.open()}));window.mapFilter={fieldsets:Array.from(t.querySelectorAll("fieldset")),selects:Array.from(t.querySelectorAll("select")),activate:e=>{t.addEventListener("change",(()=>{m(e)}))}}}(),function(){const e={BUNGALOW:0,FLAT:1e3,HOUSE:5e3,PALACE:1e4},t=document.querySelector(".ad-form"),n=t.querySelector("#room_number"),o=t.querySelector("#capacity"),r=t.querySelector("#address"),i=t.querySelector(".ad-form__reset"),a=t.querySelector("#title"),s=t.querySelector("#type"),d=t.querySelector("#price"),l=t.querySelector("#timein"),c=t.querySelector("#timeout"),u=()=>{const e=a.value.length;a.validity.tooShort?a.setCustomValidity("Нужно больше 30 символов. Сейчас: "+e):a.validity.tooLong?a.setCustomValidity("Нужно меньше 100 символов. Сейчас: "+e):a.validity.valueMissing?a.setCustomValidity("Нужно написать заголовок"):a.setCustomValidity("")},p=()=>{const t=e[s.value.toUpperCase()];d.min=t,d.placeholder=t.toString()},m=()=>{d.validity.valueMissing?d.setCustomValidity("Нужно установить цену"):d.validity.typeMismatch?d.setCustomValidity("Вводите число"):d.validity.rangeUnderFlow?d.setCustomValidity("Слишком мало, надо больше"):d.validity.rangeOverflow?d.setCustomValidity("Слишком много, надо меньше 1000001"):d.setCustomValidity("")},f=()=>{const e=parseInt(n.value,10),t=parseInt(o.value,10);100===e&&0!==t||100!==e&&0===t?o.setCustomValidity("Такой выбор соотвествует только варианту: не для гостей"):e<t?o.setCustomValidity("Гостей должно быть меньше, чем комнат"):(o.setCustomValidity(""),n.reportValidity(),o.reportValidity())},y=e=>{c.value=e.target.value},w=e=>{l.value=e.target.value},v=()=>{window.util.openSuccessPopup(),window.pin.removeElements(),t.reset(),window.map.disablePage(),window.isLoad=!0},h=e=>{e.preventDefault(),t.reset()},L=e=>{e.preventDefault(),window.backend.post(new FormData(t),v,window.util.openErrorPopup),a.removeEventListener("input",u),s.removeEventListener("change",p),d.removeEventListener("invalid",m),n.removeEventListener("change",f),o.removeEventListener("change",f),l.removeEventListener("change",y),c.removeEventListener("change",w),i.removeEventListener("reset",h),t.removeEventListener("submit",L)};a.addEventListener("input",u),s.addEventListener("change",p),d.addEventListener("invalid",m),n.addEventListener("change",f),o.addEventListener("change",f),l.addEventListener("change",y),c.addEventListener("change",w),i.addEventListener("reset",h),t.addEventListener("submit",L),f(),p(),window.form={container:t,address:r,fieldsets:Array.from(t.querySelectorAll("fieldset"))}}(),function(){const e=document.createDocumentFragment(),t=document.createDocumentFragment(),n=window.map.workSpace.querySelector(".map__pins"),o=window.map.workSpace.querySelector(".map__pin--main"),r=Math.floor(o.offsetWidth/2),i=Math.floor(o.offsetHeight/2),a=o.offsetLeft+r,s=o.offsetTop+i,d=(e=a,t=s)=>{e=parseInt(e,10),t=parseInt(t,10),window.form.address.value=`${e}, ${t}`},l=n=>{const o=n.length>5?5:n.length;for(let r=0;r<o;r++)e.appendChild(window.advert.render(n[r])),t.appendChild(window.card.render(n[r]));window.pin.container.appendChild(e),window.pin.container.appendChild(t),u()},c=e=>{const t=Array.from(window.map.workSpace.querySelectorAll(".popup")),n=t[e].querySelector(".popup__close");t.forEach((e=>e.classList.add("hidden"))),t[e].classList.remove("hidden"),document.addEventListener("keydown",(n=>{"Escape"===n.key&&(n.preventDefault(),t[e].classList.add("hidden"))})),n.addEventListener("click",(()=>t[e].classList.add("hidden")))},u=()=>{const e=Array.from(n.querySelectorAll(".map__pin:not(.map__pin--main)"));for(let t=0;t<e.length;t++)e[t].addEventListener("click",(()=>{c(t)}))},p=()=>{n.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.classList.remove("hidden")))};window.isLoad=!0,o.addEventListener("mousedown",(e=>{if(e.preventDefault(),0===e.button){window.map.disablePage(!1,window.isLoad),window.isLoad&&(window.isLoad=!1),d(a,s+i);let t=!1,n={x:e.clientX,y:e.clientY},l=s,c=a;const u=e=>{e.preventDefault(),t=!0;const a=n.x-e.clientX,s=n.y-e.clientY;n={x:e.clientX,y:e.clientY},o.style.zIndex=2,l=o.offsetTop-s,c=o.offsetLeft-a,l<170?l=170:l>620&&(l=620),c<-32?c=-32:c>1168&&(c=1168),o.style.top=l+"px",o.style.left=c+"px",d(c+r,l+2*i)},p=e=>{if(e.preventDefault(),d(c+r,l+2*i),document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",p),t){const e=t=>{t.preventDefault(),o.removeEventListener("click",e)};o.addEventListener("click",e)}};document.addEventListener("mousemove",u),document.addEventListener("mouseup",p)}})),o.addEventListener("keydown",(e=>{"Enter"===e.key&&(window.map.disablePage(!1,window.pin.isLoad),p(),d(a,s+i))})),o.focus(),d(),window.pin={container:n,successHandler:e=>{window.mapFilter.activate(e),l(e),p()},removeElements:()=>{const e=n.querySelectorAll(".map__pin:not(.map__pin--main)"),t=window.map.workSpace.querySelectorAll(".map__card");e.forEach((e=>e.remove())),t.forEach((e=>e.remove()))},renderElements:l,open:p}}(),window.map.disablePage()})();