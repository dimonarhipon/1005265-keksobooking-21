(()=>{"use strict";(()=>{const e=document.querySelector("#success").content.querySelector(".success"),t=document.querySelector("#error").content.querySelector(".error"),o=t.querySelector(".error__button");window.util={getRandomNumber:(e,t=0)=>Math.floor(Math.random()*(e-t)+t),onLoadError:e=>{const t=document.createElement("div");t.style="z-index: 5; margin: 0 auto; text-align: center; background-color: tomato;",t.style.position="absolute",t.style.width="400px",t.style.height="80px",t.style.color="#ffffff",t.style.left=0,t.style.right=0,t.style.fontSize="28px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},openPopupSuccess:()=>{const t=e.cloneNode(!0);document.body.insertAdjacentElement("afterbegin",t),document.addEventListener("click",(()=>{t.style.display="none"})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(e.preventDefault(),t.style.display="none")}))},onPostError:()=>{const e=t.cloneNode(!0);document.body.insertAdjacentElement("afterbegin",e),document.addEventListener("click",(()=>{e.style.display="none"})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&(t.preventDefault(),e.style.display="none")})),o.addEventListener("click",(()=>{e.style.display="none"}))},debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}}}})(),(()=>{window.backend={load:(t,o)=>{const n=e(t,o);n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},post:(t,o,n)=>{const r=e(o,n);r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(t)}};const e=(e,t)=>{const o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(function(){400===o.status?t(`Неверный запрос: ${o.status} ${o.statusText}`):404===o.status?t(`Не найдено: ${o.status} ${o.statusText}`):500===o.status?t(`Ошибка сервера: ${o.status} ${o.statusText}`):200!==o.status?t(`Статус ответа: ${o.status} ${o.statusText}`):e(o.response)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${o.timeout} мс`)})),o.timeout=7e3,o}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.advert={render:t=>{const o=e.cloneNode(!0),n=o.querySelector("img");return o.style=`left: ${t.location.x}px; top: ${t.location.y}px`,n.src=t.author.avatar,n.alt=t.offer.title,o.classList.add("hidden"),o}}})(),(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t=document.querySelector("#card").content.querySelector(".map__card");window.card={render:o=>{const n=t.cloneNode(!0),r=n.querySelector(".popup__title"),a=n.querySelector(".popup__text--address"),i=n.querySelector(".popup__text--price"),d=n.querySelector(".popup__type"),s=n.querySelector(".popup__text--capacity"),l=n.querySelector(".popup__text--time "),c=n.querySelector(".popup__features"),p=n.querySelector(".popup__description"),u=n.querySelector(".popup__photos"),m=n.querySelector(".popup__avatar");return m.src=o.author.avatar,m.alt=o.offer.title,r.textContent=o.offer.title,a.textContent=o.offer.address,i.textContent=o.offer.price+" ₽/ночь.",d.textContent=e[o.offer.type],s.textContent=`${o.offer.rooms} комнаты для ${o.offer.guests} гостей`,l.textContent=`Заезд после ${o.offer.checkin}, выезд до ${o.offer.checkout}`,(e=>{c.innerHTML="";const t=document.createDocumentFragment();for(let o=0;o<e.offer.features.length;o++){const n=document.createElement("li");n.className="popup__feature popup__feature--"+e.offer.features[o],t.appendChild(n)}c.appendChild(t)})(o),p.textContent=o.offer.description,(e=>{u.innerHTML="";const t=document.createDocumentFragment();for(let o=0;o<e.offer.photos.length;o++){const n=document.createElement("img");n.src=e.offer.photos[o],n.width=40,n.height=40,t.appendChild(n)}u.appendChild(t)})(o),n.classList.add("hidden"),n}}})(),(()=>{const e=document.querySelector(".map");window.map={workSpace:e,disablePage:(t=!0,o=!1)=>{e.classList.add("map--faded"),window.form.container.classList.add("ad-form--disabled"),window.form.fieldsets.map((e=>e.disabled=t)),window.mapFilter.fieldsets.map((e=>e.disabled=t)),window.mapFilter.selects.map((e=>e.disabled=t)),window.form.onRoomAndCapacitySelectChange(),window.form.onTypeHouseChange(),(e=>{e&&window.backend.load(window.pin.onLoadSuccess,window.util.onLoadError)})(o),t||(e.classList.remove("map--faded"),window.form.container.classList.remove("ad-form--disabled"))}}})(),(()=>{const e={ANY:{min:0,max:1/0},LOW:{min:0,max:1e4},MIDDLE:{min:1e4,max:5e4},HIGH:{min:5e4,max:1/0}},t=window.map.workSpace.querySelector(".map__filters"),o=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),a=t.querySelector("#housing-guests"),i=t.querySelector("#housing-features"),d=(e,t,o)=>"any"===e.value||e.value===t[o].toString(),s=window.util.debounce((t=>{const s=t;window.pin.removeElements();const l=[];for(let t=0;t<s.length;t++){let c=s[t];const p=e[n.value.toUpperCase()],u=Array.from(i.querySelectorAll("input:checked")),m=d(o,c.offer,"type"),w=!p||c.offer.price>=p.min&&c.offer.price<=p.max,f=d(r,c.offer,"rooms"),y=d(a,c.offer,"guests"),v=u.every((e=>c.offer.features.includes(e.value)));if(m&&w&&f&&y&&v&&l.push(c),l.length>=5)break}window.pin.renderElements(l),window.pin.open()}));window.mapFilter={PINS_LIMIT:5,form:t,fieldsets:Array.from(t.querySelectorAll("fieldset")),selects:Array.from(t.querySelectorAll("select")),activate:e=>{t.addEventListener("change",(()=>{s(e)}))}}})(),(()=>{const e="img/muffin-grey.svg",t=1e3,o={BUNGALOW:0,FLAT:1e3,HOUSE:5e3,PALACE:1e4},n=document.querySelector(".ad-form"),r=n.querySelector("#room_number"),a=n.querySelector("#capacity"),i=n.querySelector("#address"),d=n.querySelector(".ad-form__reset"),s=n.querySelector("#title"),l=n.querySelector("#type"),c=n.querySelector("#price"),p=n.querySelector("#timein"),u=n.querySelector("#timeout"),m=()=>{const e=o[l.value.toUpperCase()];c.min=e,c.placeholder=e.toString()},w=()=>{const e=parseInt(r.value,10),t=parseInt(a.value,10);100!==e||0===t?100===e||0!==t?e<t?a.setCustomValidity("Гостей должно быть меньше, чем комнат"):(a.setCustomValidity(""),r.reportValidity(),a.reportValidity()):a.setCustomValidity("Такой выбор соотвествует только варианту 100 комнат"):a.setCustomValidity("Такой выбор соотвествует только варианту: не для гостей")},f=(e=window.pin.markerHeight)=>{const t=window.pin.marker.offsetLeft+window.pin.markerWidth,o=window.pin.marker.offsetTop+e;window.pin.setCoordinate(t,o)},y=()=>{window.util.openPopupSuccess(),window.pin.removeElements(),window.mapFilter.form.reset(),n.reset(),c.min=t,c.placeholder=t,window.map.disablePage(),f(),window.isLoad=!0};s.addEventListener("input",(()=>{const e=s.value.length;s.validity.tooShort?s.setCustomValidity("Нужно больше 30 символов. Сейчас: "+e):s.validity.tooLong?s.setCustomValidity("Нужно меньше 100 символов. Сейчас: "+e):s.validity.valueMissing?s.setCustomValidity("Нужно написать заголовок"):s.setCustomValidity("")})),l.addEventListener("change",m),c.addEventListener("invalid",(()=>{c.validity.valueMissing?c.setCustomValidity("Нужно установить цену"):c.validity.typeMismatch?c.setCustomValidity("Вводите число"):c.validity.rangeUnderFlow?c.setCustomValidity("Слишком мало, надо больше"):c.validity.rangeOverflow?c.setCustomValidity("Слишком много, надо меньше 1000001"):c.setCustomValidity("")})),r.addEventListener("change",w),a.addEventListener("change",w),p.addEventListener("change",(e=>{u.value=e.target.value})),u.addEventListener("change",(e=>{p.value=e.target.value})),d.addEventListener("click",(o=>{o.preventDefault(),n.reset(),c.min=t,c.placeholder=t,f(2*window.pin.markerHeight),window.loadImage.previewAvatar.src=e,window.loadImage.previewPhoto.querySelector("img")&&window.loadImage.previewPhoto.querySelector("img").remove()})),n.addEventListener("submit",(t=>{t.preventDefault(),window.backend.post(new FormData(n),y,window.util.onPostError),window.pin.marker.style.top=window.pin.markerStartTop-window.pin.markerHeight+"px",window.pin.marker.style.left=window.pin.markerStartLeft-window.pin.markerWidth+"px",window.loadImage.previewAvatar.src=e,window.loadImage.previewPhoto.querySelector("img")&&window.loadImage.previewPhoto.querySelector("img").remove()})),window.form={container:n,address:i,fieldsets:Array.from(n.querySelectorAll("fieldset")),onRoomAndCapacitySelectChange:w,onTypeHouseChange:m}})(),(()=>{const e=document.createDocumentFragment(),t=document.createDocumentFragment(),o=window.map.workSpace.querySelector(".map__pins"),n=window.map.workSpace.querySelector(".map__pin--main"),r=Math.floor(n.offsetWidth/2),a=Math.floor(n.offsetHeight/2),i=n.offsetLeft+r,d=n.offsetTop+a,s=(e=i,t=d)=>{window.form.address.value=`${e}, ${t}`},l=o=>{const n=o.length>window.mapFilter.PINS_LIMIT?window.mapFilter.PINS_LIMIT:o.length;for(let r=0;r<n;r++)e.appendChild(window.advert.render(o[r])),t.appendChild(window.card.render(o[r]));window.pin.container.appendChild(e),window.pin.container.appendChild(t),p()},c=e=>{const t=Array.from(window.map.workSpace.querySelectorAll(".popup")),o=t[e].querySelector(".popup__close");t.forEach((e=>e.classList.add("hidden"))),t[e].classList.remove("hidden"),document.addEventListener("keydown",(o=>{"Escape"===o.key&&(o.preventDefault(),t[e].classList.add("hidden"))})),o.addEventListener("click",(()=>t[e].classList.add("hidden")))},p=()=>{const e=Array.from(o.querySelectorAll(".map__pin:not(.map__pin--main)"));for(let t=0;t<e.length;t++)e[t].addEventListener("click",(()=>{c(t)}))},u=()=>{o.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.classList.remove("hidden")))};window.isLoad=!0,n.addEventListener("mousedown",(e=>{if(e.preventDefault(),0===e.button){window.map.disablePage(!1,window.isLoad),window.isLoad&&(window.isLoad=!1),s(i,d+a);let t=!1,o={x:e.clientX,y:e.clientY},l=d,c=i;const p=e=>{e.preventDefault(),t=!0;const i=o.x-e.clientX,d=o.y-e.clientY;o={x:e.clientX,y:e.clientY},n.style.zIndex=2,l=n.offsetTop-d,c=n.offsetLeft-i,l<170?l=170:l>620&&(l=620),c<-32?c=-32:c>1168&&(c=1168),n.style.top=l+"px",n.style.left=c+"px",s(c+r,l+2*a)},u=e=>{if(e.preventDefault(),s(c+r,l+2*a),document.removeEventListener("mousemove",p),document.removeEventListener("mouseup",u),t){const e=t=>{t.preventDefault(),n.removeEventListener("click",e)};n.addEventListener("click",e)}};document.addEventListener("mousemove",p),document.addEventListener("mouseup",u)}})),n.addEventListener("keydown",(e=>{"Enter"===e.key&&(window.map.disablePage(!1,window.pin.isLoad),u(),s(i,d+a))})),n.focus(),s(),window.pin={container:o,setCoordinate:s,marker:n,markerWidth:r,markerHeight:a,markerStartTop:d,markerStartLeft:i,onLoadSuccess:e=>{window.mapFilter.activate(e),l(e),u()},removeElements:()=>{const e=o.querySelectorAll(".map__pin:not(.map__pin--main)"),t=window.map.workSpace.querySelectorAll(".map__card");e.forEach((e=>e.remove())),t.forEach((e=>e.remove()))},renderElements:l,open:u}})(),(()=>{const e=["gif","jpg","jpeg","png","svg","webp"],t=window.form.container.querySelector("#avatar"),o=window.form.container.querySelector(".ad-form-header__preview").querySelector("img"),n=window.form.container.querySelector("#images"),r=window.form.container.querySelector(".ad-form__photo");t.addEventListener("change",(()=>{const n=t.files[0],r=n.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result,o.style.objectFit="contain"})),e.readAsDataURL(n)}})),n.addEventListener("change",(()=>{const t=n.files[0],o=t.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{const t=r.querySelector("img");if(null===t){const t=document.createElement("img");t.width=70,t.height=70,t.style.objectFit="contain",t.src=e.result,r.appendChild(t)}t&&(t.src=e.result,t.style.objectFit="contain")})),e.readAsDataURL(t)}})),window.loadImage={previewAvatar:o,previewPhoto:r}})(),window.map.disablePage()})();